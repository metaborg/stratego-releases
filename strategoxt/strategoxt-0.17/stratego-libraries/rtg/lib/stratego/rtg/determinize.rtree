Module("stratego/rtg/determinize",[Imports([Import("stratego/rtg/signature"),Import("libstratego-lib")]),Strategies([SDefNoArgs("rtg-determinize",Seq(Match(NoAnnoList(Op("RTG",[NoAnnoList(Op("Start",[Var("states-start")])),NoAnnoList(Op("ProdRules",[Var("trans")]))]))),Seq(Call(SVar("topdown"),[Call(SVar("try"),[Choice(Match(NoAnnoList(Op("Ref",[RootApp(Id)]))),Choice(CallNoArgs(SVar("rtgdet-normalize-none")),Choice(CallNoArgs(SVar("rtgdet-normalize-some")),CallNoArgs(SVar("rtgdet-normalize-conc")))))])]),Seq(Where(Seq(Assign(Var("state-states-d-tbl"),RootApp(CallNoArgs(SVar("new-hashtable")))),Seq(Assign(Var("states-d-set"),RootApp(CallNoArgs(SVar("new-iset")))),Seq(Assign(Var("trans-d-set"),RootApp(CallNoArgs(SVar("new-iset")))),Seq(Assign(Var("reverse-trans-tbl"),RootApp(CallNoArgs(SVar("new-hashtable")))),Assign(Var("symbol-tbl"),RootApp(CallNoArgs(SVar("new-hashtable"))))))))),Seq(CallT(SVar("rtgdet-init-reverse-trans"),[],[Var("reverse-trans-tbl")]),Seq(CallT(SVar("rtgdet-init-symbol-tbl"),[],[Var("symbol-tbl")]),Seq(BA(CallNoArgs(SVar("hashtable-keys")),Var("reverse-trans-tbl")),Seq(Call(SVar("strrtg-repeat"),[Call(SVar("strrtg-list-loop1"),[CallT(SVar("rtg-determinize-step"),[],[Var("state-states-d-tbl"),Var("states-d-set"),Var("reverse-trans-tbl"),Var("symbol-tbl"),Var("trans-d-set")])])]),Seq(Assign(Var("states-d"),App(CallNoArgs(SVar("iset-elements")),Var("states-d-set"))),Seq(Assign(Var("states-start-d"),App(CallT(SVar("rtg-determinize-start-states"),[],[Var("states-start")]),Var("states-d"))),Seq(Assign(Var("trans-d"),App(CallNoArgs(SVar("iset-elements")),Var("trans-d-set"))),Seq(Where(Seq(BA(CallNoArgs(SVar("iset-destroy")),Var("states-d-set")),Seq(BA(CallNoArgs(SVar("iset-destroy")),Var("trans-d-set")),Seq(BA(CallNoArgs(SVar("hashtable-destroy")),Var("state-states-d-tbl")),Seq(BA(CallNoArgs(SVar("hashtable-destroy")),Var("reverse-trans-tbl")),BA(CallNoArgs(SVar("hashtable-destroy")),Var("symbol-tbl"))))))),Build(NoAnnoList(Op("RTG",[NoAnnoList(Op("Start",[Var("states-start-d")])),NoAnnoList(Op("ProdRules",[Var("trans-d")]))]))))))))))))))),RDefNoArgs("rtgdet-normalize-none",RuleNoCond(NoAnnoList(Op("Appl",[NoAnnoList(Op("Term",[NoAnnoList(Str("\"None\""))])),NoAnnoList(List([]))])),NoAnnoList(Op("Appl",[NoAnnoList(Op("NoneTerm",[])),NoAnnoList(List([]))])))),RDefNoArgs("rtgdet-normalize-some",RuleNoCond(NoAnnoList(Op("Appl",[NoAnnoList(Op("Term",[NoAnnoList(Str("\"Some\""))])),NoAnnoList(List([Var("t")]))])),NoAnnoList(Op("Appl",[NoAnnoList(Op("SomeTerm",[])),NoAnnoList(List([Var("t")]))])))),RDefNoArgs("rtgdet-normalize-conc",RuleNoCond(NoAnnoList(Op("Appl",[NoAnnoList(Op("Term",[NoAnnoList(Str("\"Conc\""))])),NoAnnoList(List([Var("t1"),Var("t2")]))])),NoAnnoList(Op("Appl",[NoAnnoList(Op("ConcTerm",[])),NoAnnoList(List([Var("t1"),Var("t2")]))])))),SDefT("rtg-determinize-start-states",[],[DefaultVarDec("states-start")],Call(SVar("retain-all"),[CallT(SVar("rtg-determinize-start-state"),[],[Var("states-start")])])),SDefT("rtg-determinize-start-state",[],[DefaultVarDec("states-start")],Where(Seq(BA(CallNoArgs(SVar("isect")),NoAnnoList(Tuple([RootApp(Call(SVar("try"),[Match(NoAnnoList(Op("Set",[RootApp(Id)])))])),Var("states-start")]))),Not(Match(NoAnnoList(List([]))))))),SDefT("rtg-determinize-step",[],[DefaultVarDec("state-states-d"),DefaultVarDec("states-d"),DefaultVarDec("reverse-trans"),DefaultVarDec("symbol-tbl"),DefaultVarDec("trans-d")],Seq(Match(As(Var("a"),NoAnnoList(Op("Appl",[Var("f"),Var("qs")])))),Let([SDefT("get-states-d",[],[DefaultVarDec("t")],LChoice(BA(CallT(SVar("hashtable-get"),[],[Var("t")]),Var("state-states-d")),Build(NoAnnoList(List([]))))),SDefT("add-state-d",[],[DefaultVarDec("q"),DefaultVarDec("s")],Scope(["ss"],Seq(LChoice(BA(CallT(SVar("hashtable-get"),[],[Var("q")]),Var("state-states-d")),Build(NoAnnoList(List([])))),Seq(Assign(Var("ss"),RootApp(LChoice(Call(SVar("fetch"),[Match(Var("s"))]),Build(NoAnnoList(ListTail([Var("s")],RootApp(Id))))))),Seq(BA(CallT(SVar("hashtable-put"),[],[Var("q"),Var("ss")]),Var("state-states-d")),BA(CallT(SVar("iset-add"),[],[Var("s")]),Var("states-d"))))))),SDefT("add-transition-d",[],[DefaultVarDec("s")],Scope(["p"],Seq(Assign(Var("p"),NoAnnoList(Op("ProdRule",[Var("s"),NoAnnoList(List([NoAnnoList(Op("Appl",[Var("f"),RootApp(Id)]))]))]))),BA(CallT(SVar("iset-add"),[Fail],[Var("p")]),Var("trans-d"))))),SDefNoArgs("make-unique-state",Seq(Call(SVar("quick-sort"),[CallNoArgs(SVar("term-address-lt"))]),Build(NoAnnoList(Op("Set",[RootApp(CallNoArgs(SVar("make-set")))]))))),SDefNoArgs("get-states-to",Scope(["s"],Seq(Match(Var("s")),BA(CallT(SVar("hashtable-get"),[],[Var("s")]),Var("reverse-trans"))))),SDefT("appl-matches-s1n",[],[DefaultVarDec("s1n")],Scope(["f","qs"],Where(Seq(Match(NoAnnoList(Op("Appl",[Var("f"),Var("qs")]))),Seq(Build(NoAnnoList(Tuple([Var("qs"),Var("s1n")]))),Call(SVar("zip"),[Scope(["q","s"],Seq(Match(NoAnnoList(Tuple([Var("q"),Var("s")]))),BA(Call(SVar("fetch"),[Seq(Match(NoAnnoList(Op("Set",[RootApp(Id)]))),Call(SVar("fetch"),[Match(Var("q"))]))]),Var("s"))))]))))))],Seq(Id,Seq(Assign(Var("s1n"),App(Call(SVar("map"),[LRule(RuleNoCond(Var("q"),App(CallT(SVar("get-states-d"),[],[Var("q")]),NoAnnoList(Tuple([])))))]),Var("qs"))),Seq(Assign(Var("s1n'"),App(CallNoArgs(SVar("list-combinations")),Var("s1n"))),Seq(BA(CallT(SVar("hashtable-get"),[],[NoAnnoList(Op("Appl",[Var("f"),App(CallNoArgs(SVar("length")),Var("qs"))]))]),Var("symbol-tbl")),Seq(Assign(Var("as"),RootApp(Call(SVar("retain-all"),[CallT(SVar("appl-matches-s1n"),[],[Var("s1n")])]))),Seq(Assign(Var("to"),App(Call(SVar("mapconcat"),[CallNoArgs(SVar("get-states-to"))]),Var("as"))),Seq(Assign(Var("s"),App(CallNoArgs(SVar("make-unique-state")),Var("to"))),Seq(BA(CallNoArgs(SVar("length")),Var("s1n'")),Seq(BA(Call(SVar("strrtg-list-loop1"),[CallT(SVar("add-transition-d"),[],[Var("s")])]),Var("s1n'")),BA(Call(SVar("map"),[LRule(RuleNoCond(Var("q"),App(CallT(SVar("add-state-d"),[],[Var("q"),Var("s")]),NoAnnoList(Tuple([])))))]),Var("to"))))))))))))))]),Strategies([SDefT("rtgdet-init-reverse-trans",[],[DefaultVarDec("tbl")],Where(Seq(Match(NoAnnoList(Op("RTG",[NoAnnoList(Op("Start",[Var("states-start")])),NoAnnoList(Op("ProdRules",[RootApp(Id)]))]))),Call(SVar("map"),[CallT(SVar("rtgdet-init-reverse-trans"),[],[Var("tbl")])])))),SDefT("rtgdet-init-reverse-trans",[],[DefaultVarDec("tbl")],Where(Seq(Match(NoAnnoList(Op("ProdRule",[Var("q"),NoAnnoList(List([NoAnnoList(Op("Appl",[Var("f"),Var("qs")]))]))]))),BA(CallT(SVar("hashtable-push"),[],[NoAnnoList(Op("Appl",[Var("f"),Var("qs")])),Var("q")]),Var("tbl")))))]),Strategies([SDefT("rtgdet-init-symbol-tbl",[],[DefaultVarDec("tbl")],Where(Seq(Match(NoAnnoList(Op("RTG",[NoAnnoList(Op("Start",[Var("states-start")])),NoAnnoList(Op("ProdRules",[RootApp(Id)]))]))),Call(SVar("map"),[CallT(SVar("rtgdet-init-symbol-tbl"),[],[Var("tbl")])])))),SDefT("rtgdet-init-symbol-tbl",[],[DefaultVarDec("tbl")],Where(Seq(Match(NoAnnoList(Op("ProdRule",[Wld,NoAnnoList(List([As(Var("a"),NoAnnoList(Op("Appl",[Var("f"),Var("qs")])))]))]))),BA(CallT(SVar("hashtable-push"),[],[NoAnnoList(Op("Appl",[Var("f"),App(CallNoArgs(SVar("length")),Var("qs"))])),Var("a")]),Var("tbl")))))]),Strategies([ExtSDef("strrtg-repeat",[DefaultVarDec("s")],[]),ExtSDef("strrtg-list-loop1",[DefaultVarDec("s")],[])])])
